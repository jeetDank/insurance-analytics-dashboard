<mat-drawer-container style="width: 100vw; height: 100vh" autosize>
  <mat-drawer
    class="sidebar-container border-end"
    #drawer
    [opened]="false"
    mode="side"
  >
    <app-sidebar (sidebarData)="catchSidebarDataChange($event)"></app-sidebar>
  </mat-drawer>

  <div class="content">
    <nav class="sticky-top navbar nav-cust-props border-bottom">
      <div class="d-flex align-items-center w-100">
        <!-- uncomment to display the toggle sidebar button -->

        <!-- <span (click)="drawer.toggle()">
          <app-icon name="Menu"></app-icon>  

        </span> -->

        <span class="">
          <h5>Financial Analysis Dashboard</h5>
        </span>

        <p-button
          (click)="previousDashboards = true"
          class="ms-auto me-3"
          variant="outlined"
          icon="pi pi-history"
          severity="secondary"
          label="Previous Dashboards"
        />
        <p-button
          (click)="formulas = true"
          class=""
          variant="outlined"
          icon="pi pi-calculator"
          severity="secondary"
          label="Saved Formulas"
        />
      </div>
    </nav>
    <div class="canvas">
      <div class="banner">
        <div class="banner-icon-container me-3">
          <span class="pi pi-chart-bar"></span>
        </div>

        <div class="banner-icon-container">
          <span class="pi pi-chart-line"></span>
        </div>

        <div class="ms-4">
          <div>
            <h4 class="text-light">Financial Analysis Dashboard</h4>
          </div>
          <div class="text-light">
            AI generated insights through comparative analysis of SEC filings
          </div>
        </div>
      </div>

      <div
        class="query-container position-relative border rounded shadow-sm p-3 bg-dark text-light"
      >
        <!-- Spinner: top-right -->
        <div class="position-absolute top-0 end-0 mt-2 me-3">
          @if(isLoaderShowing){
          <p-progress-spinner
            strokeWidth="5"
            ariaLabel="loading"
            [style]="{ width: '30px', height: '30px' }"
          ></p-progress-spinner>
          }
        </div>

        <!-- Textarea -->
        <div class="mb-5 w-100">
          <!-- gives space for bottom button -->
          <textarea
            [(ngModel)]="userQuery"
            placeholder="Enter your analysis prompt here..."
            class="query-text-area form-control bg-dark text-light border-0 shadow-none"
            rows="6"
            (keyup.enter)="sendQuery()"
          ></textarea>
        </div>

        <!-- Button: bottom-right -->
        
        <div class="position-absolute end-0 mb-3 me-3" style="bottom:40px">
          <p-button
            [disabled]="isLoaderShowing"
            severity="contrast"
            icon="pi pi-send"
            (click)="sendQuery()"
            type="submit"
            
          ></p-button>
        </div>
        <div class="position-absolute bottom-0 end-0 mb-3 me-3 " >
          <p-button
            type="button"
            [disabled]="isLoaderShowing"
            severity="contrast"
            icon="pi pi-refresh"
            (click)="clearData()"
          ></p-button>
        </div>
      </div>

      @if (this.currentMsg != null) {
      <div class="mt-3 mb-3">
        <div class="flex-grow-1">
          <p-message
            icon="pi pi-info-circle"
            styleClass="rounded-1"
            variant="outlined"
            [severity]="this.currentMsg.type"
            >{{ this.currentMsg.text }}</p-message
          >
        </div>
      </div>
      }

      <!-- Ambiguity correction section  -->

      <!-- <div class="mt-5 mb-5" >
        <div
          class="mt-5 d-flex justify-content-between align-items-center mb-4"
        >
          <h4 class="mb-0">
            Resolve Ambiguity
            <span>
              <i
                class="pi pi-info-circle"
                title="We couldnâ€™t understand a few words in your query. Try rewording it for more accurate results."
              ></i>
            </span>
          </h4>
        </div>

        <div class="mt-2 mb-2">
          We have an ambiguity issue
          <span class="text-warning"> " some word "</span>
        </div>
        <div class="mt-2 mb-2">Go ahead and pick one of the suggestions!</div>

        <div class="mb-2 mt-2">
          <p-select
            [options]="allResponses.ambiguity[0]?.options"
            [(ngModel)]="allResponses.ambiguity[0].selectedOption"
            optionLabel="name"
            placeholder="Select"
            styleClass="bg-dark w-25"
          />
        </div>
      </div> -->

      <!-- loader and msg  -->

      @if(userQuery == "" ){
      <div class="sample-prompt-container mt-3">
        <div class="mb-2 w-100">Sample Prompts:</div>
        @for (item of samplePrompts; track $index) {
        <p-button
          (click)="pushPromptToQueryBox(item)"
          class="mt-2 mb-2 me-2"
          variant="outlined"
          [label]="item.prompt"
          severity="secondary"
        />
        }
      </div>

      }
      <!-- <div class="mb-2 mt-2">
        <p-progressbar mode="indeterminate" [style]="{ height: '3px' }" />
      </div> -->

      @if (allResponses.parsedData) {
      <div class="mt-3">
        <div class="border-top border-dark mt-5 mb-5"></div>

        <app-accordian
          [parsedQuery]="this.allResponses.parsedData"
        ></app-accordian>
      </div>
      } @if (allResponses.companyData) {
      <div class="mt-3">
        <app-accordian
          [companyData]="this.allResponses.companyData"
        ></app-accordian>
      </div>
      } @if (allResponses.analysisData) {
      <div class="mt-3">
        <app-accordian
          [apiResponse]="this.allResponses.analysisData"
        ></app-accordian>
      </div>
      }

      <!-- <div class="row" cdkDropList (cdkDropListDropped)="drop($event)">
        @for (item of cardData; track $index) {
        <div class="col-sm-12 col-lg-6">
          <div class="draggable-card" class="mb-2" cdkDrag>
            <app-common-card [cardData]="item"></app-common-card>
          </div>
        </div>
        }
      </div> -->

      @if (comparisonMetrics.length > 0) {
      <div class="mt-5 d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">Financial Metrics</h3>
      </div>
      }

      <!-- Comparison View -->

      <div class="comparison-container">
        <!-- Company Header Pills -->

        @if (companies.length> 0) {
        <div class="company-pills mb-4">
          <div class="d-flex flex-wrap gap-2">
            @for (company of companies; track company) {
            <span class="badge badge-company">
              {{ company }}
            </span>
            }
          </div>
        </div>

        }

        <!-- Comparison Metrics Grid -->
        <div class="metrics-comparison">
          @for (metric of comparisonMetrics; track metric.metricName) {
          <div class="comparison-metric-card mb-4">
            <!-- Metric Header -->
            <div class="metric-header">
              <h5 class="metric-title mb-0">
                {{ metric.metricName }}
                <i
                  class="pi pi-info-circle ms-2 cursor-pointer"
                  (click)="op.toggle($event); updateFormulaToggleData(metric)"
                ></i>
              </h5>
              @if (metric.subTitle) {
              <p class="metric-subtitle text-muted mb-0">
                {{ metric.subTitle }}
              </p>
              }
            </div>

            <!-- Company Columns -->
            <div class="row g-3 mt-2">
              @for (company of companies; track company) {
              <div [class]="getColumnClass()">
                <div
                  class="company-metric-card"
                  [class.unavailable]="!metric.companies[company].available"
                >
                  <!-- Company Name Badge -->
                  <div class="company-name-badge mb-2">
                    {{ company }}
                  </div>

                  @if (metric.companies[company].available) {
                  <!-- Available Metric -->
                  <div class="metric-value-section">
                    <h3 class="metric-value mb-1">
                      {{ metric.companies[company].metric }}
                    </h3>
                    <p class="metric-period text-muted mb-2">
                      {{ metric.companies[company].metricPeriod }}
                    </p>
                    <div
                      class="trend-badge"
                      [class.trend-positive]="
                        metric.companies[company].trendPositive
                      "
                      [class.trend-negative]="
                        !metric.companies[company].trendPositive
                      "
                    >
                      <i
                        [class]="metric.companies[company].trendIcon + ' me-1'"
                      ></i>
                      <span>{{ metric.companies[company].trend }}</span>
                    </div>
                  </div>
                  } @else {
                  <!-- Unavailable Metric -->
                  <div class="unavailable-section">
                    <i class="pi pi-info-circle unavailable-icon mb-2"></i>
                    <p class="unavailable-text mb-0">
                      Not available for<br />{{ company }}
                    </p>
                  </div>
                  }
                </div>
              </div>
              }
            </div>
          </div>
          }
        </div>
      </div>

      <!-- @if (true) {
        <div class="row mb-3">
        <div class="col-sm-12 col-lg-6">
          <app-container-card>
            <div>
              <div class="chart-title">Apple Revenue by Segment</div>
              <app-echarts
                style="height: 300px"
                [options]="appleOption"
              ></app-echarts>
            </div>
          </app-container-card>
        </div>
        <div class="col-sm-12 col-lg-6">
          <app-container-card>
            <div>
              <div class="chart-title">Microsoft Revenue by Segment</div>
              <app-echarts
                style="height: 300px"
                [options]="microsoftOption"
              ></app-echarts>
            </div>
          </app-container-card>
        </div>
      </div>
      } -->

      @if (chartOptions && chartOptions.length > 0 && typeof chartOptions != 'string') {
      <div class="mt-5 d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">Charts</h3>
      </div>

      <div class="row mb-3">
        @for (chart of chartOptions; track chart.cik + chart.metricName) {
        <div class="col-sm-12 col-lg-6">
          <app-container-card>
            <div>
              <div class="chart-title">
                {{ chart.companyName }} - {{ chart.metricName }} ({{
                  chart.period
                }})
              </div>
              <app-echarts
                style="height: 300px"
                [options]="chart.chartOption"
              ></app-echarts>
            </div>
          </app-container-card>
        </div>
        }
      </div>
      } @if (referencesData!=null && referencesData.length > 0) {
      <div class="mt-5 d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">References & Sources</h3>
      </div>

      @for (refData of referencesData; track $index) {

      <div ngbAccordion class="dark-accordion mt-2">
        <div ngbAccordionItem class="dark-accordion-item">
          <h2 ngbAccordionHeader class="dark-accordion-header">
            <button ngbAccordionButton class="dark-accordion-button">
              {{ refData.companyName }}
            </button>
          </h2>
          <div ngbAccordionCollapse>
            <div ngbAccordionBody>
              <ng-template>
                @for (section of refData.sections; track section.sectionName) {
                <div class="mb-3">
                  <h6 class="text-primary">{{ section.sectionName }}</h6>
                  <ul class="list-unstyled">
                    @for (reference of section.references; track reference.link)
                    {
                    <li class="mb-2">
                      <span class="me-2">
                        @if (reference.logo) {
                        <i [class]="reference.logo"></i>
                        }
                      </span>

                      <a
                        [href]="reference.link"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-primary"
                      >
                        {{ reference.label }}
                      </a>
                    </li>
                    }
                  </ul>
                </div>
                }
              </ng-template>
            </div>
          </div>
        </div>
      </div>
      } }

      <app-card-skeleton></app-card-skeleton>
      <div style="height: 50px"></div>
    </div>
  </div>
</mat-drawer-container>

<p-drawer
  [(visible)]="previousDashboards"
  [style]="{ width: '350px', 'background-color': 'black' }"
  position="right"
>
  <app-past-dashboards></app-past-dashboards>
</p-drawer>

<p-drawer
  [(visible)]="formulas"
  [style]="{ width: '350px', 'background-color': 'black' }"
  position="right"
>
  <app-saved-formulas></app-saved-formulas>
</p-drawer>

<p-popover #op styleClass="dark-popover">
  <!-- popover.component.html -->
  <div class="popover-body p-3">
    <!-- Metric -->
    <h6 class="mb-1 fw-semibold text-primary">
      {{ this.popoverData?.metricName ? this.popoverData?.metricName : "N/A" }}
    </h6>

    <!-- Definition -->
    <p class="text-secondary mb-3">
      {{ this.popoverData?.formula?.use }}
    </p>

    <!-- Formula label + Edit button -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <label class="fw-medium mb-0 text-primary">Formula</label>
    </div>

    <!-- Input box -->
    <input
      disabled
      type="text"
      class="form-control dark-input mb-3"
      placeholder="Enter formula here..."
      [value]="
        this.popoverData?.formula?.formula
          ? this.popoverData?.formula?.formula
          : 'N/A'
      "
    />
  </div>
</p-popover>
